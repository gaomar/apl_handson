
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>APLハンズオン</title>
  <script src="../../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="../../elements/codelab.html">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <style is="custom-style">
    body {
      font-family: "Roboto",sans-serif;
      background: var(--google-codelab-background, #F8F9FA);
    }
  </style>
  
</head>
<body unresolved class="fullbleed">

  <google-codelab title="APLハンズオン"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="プロジェクトを作成する" duration="0">
        <p>新規スキルのプロジェクトを作成します。こちらにアクセスしてください。</p>
<p><a href="https://developer.amazon.com/ja/alexa-skills-kit" target="_blank">https://developer.amazon.com/ja/alexa-skills-kit</a></p>
<h2>1-1. スキル開発を始めよう！</h2>
<p>［スキル開発を始める］をクリックします。</p>
<p><img alt="s100" src="img/2991a1ad453628b4.png"></p>
<p>Amazonのアカウント情報を入力してログインします。</p>
<p><img alt="s101" src="img/6853ea6815eaf1bb.png"></p>
<p>［スキルの作成］ボタンをクリックします。</p>
<p><img alt="s102" src="img/feb8e0cf75c3965a.png"></p>
<p>スキル名を入力して、［カスタム］と［Alexaがホスト］をそれぞれ選択します。<br><br>最後に［スキルを作成］ボタンをクリックします。</p>
<p><img alt="s103" src="img/bcfb36727368b7b1.png"></p>
<p>左側のメニューにある［呼び出し名］をクリックします。スキル名を「ハロー」に変更します。<br><br>必ず変更したら必ず［モデルを保存］と［モデルをビルド］をクリックします。</p>
<p>※保存してビルドをしないと反映されないので注意しましょう！</p>
<p><img alt="s104" src="img/5c9e7cb746e172ee.png"></p>
<h2>1-2. シミュレーターで動かそう</h2>
<p>Alexaは実機が無くても動作を確認することができます。<br><br>テストタブをクリックして、プルダウンメニューから［開発中］を選択します。</p>
<p><img alt="s110" src="img/96a254b0546391c4.png"></p>
<p>これでシミュレーターの準備ができました。「ハローをひらいて」と入力して、スキルが動作することを確認します。<br><br>今は英語の文章が返ってくれば問題ありません。</p>
<p><img alt="s111" src="img/b05513624c42defb.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Alexa Presentation Languageに触れてみよう！" duration="0">
        <p>いよいよAlexa Presentation Language（以降 APL）に触れていきたいと思います。<br><br>APLは2018年10月30日にパブリックベータ版として公開されました。</p>
<p><a href="https://developer.amazon.com/ja/blogs/alexa/post/be1b08ef-fa61-4884-9e30-1d6ff6882dba/jp-alexa-presentation-language-publicbeta" target="_blank">https://developer.amazon.com/ja/blogs/alexa/post/be1b08ef-fa61-4884-9e30-1d6ff6882dba/jp-alexa-presentation-language-publicbeta</a></p>
<p>簡単にAPLを解説するとEcho ShowやEcho Spotなどの画面付きスマートスピーカーに対してよりリッチな表現を実現するための新デザイン言語です。</p>
<h2>2-1. APLを有効化</h2>
<p>APLは初期状態では無効設定になっていますので、必ず使用する際は設定を有効にする必要があります。</p>
<p>ビルドタブを押して元の画面に戻ります。</p>
<p>左側のメニューの［インターフェース］をクリックして、<br><br>「Displayインターフェース」と「Alexa Presentation Language」のチェックを有効にします。<br><br>必ずこの2つを有効にしてください。最後に［保存］と［ビルド］ボタンをクリックしてください。</p>
<p><img alt="s200" src="img/e833f512ae6e0b3e.png"></p>
<h2>2-2. APLに触れる</h2>
<p>左側のメニューにある［画面表示］をクリックします。すると別の画面の画面が表示されます。<br>直接リンクから飛ぶこともできます。</p>
<p><a href="https://developer.amazon.com/alexa/console/ask/displays" target="_blank">https://developer.amazon.com/alexa/console/ask/displays</a></p>
<p><img alt="s210" src="img/b58e2cb3eeef6de0.png"></p>
<p>画面が表示されたら、［コードをアップロード］をクリックします。<br><br>アップロードするコードはこちらからダウンロードしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_hello.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_hello.json</a></p>
<p><img alt="s211" src="img/83bf7ea10d1c7a0d.png"></p>
<p>アップロードすると編集画面が表示されます。</p>
<p><img alt="s212" src="img/94fd73876327c0c4.png"></p>
<h2>2-3. 文字を変えてみよう</h2>
<p>「ハローAPL」と書かれている文字を違う文字に変えてみましょう。<br><br>編集方法は「JSONデータ」タブをクリックします。すると表示されている内容が変わります。「ハローAPL」と書かれている部分を好きな文字に変えてみましょう。するとリアルタイムで文字列が変更されます。</p>
<p><img alt="s213" src="img/9cf93b76b9da6413.png"></p>
<h2>2-4. 背景画像を入れてみよう</h2>
<p>背景が黒一色だと寂しいですね。レイアウト画面から<code>Image</code>を追加して、背景を実装してみましょう。</p>
<p>レイアウト選択で一番最初にあるContainerをクリックして、［＋］ボタンをクリックします。</p>
<p><img alt="s220" src="img/872cc9e9cd356041.png"></p>
<p>ポップアップが表示されるので、プルダウンメニューから<code>Image</code>を選択し、［typeを追加］ボタンをクリックします。</p>
<p><img alt="s221" src="img/bf70bbfc2e8cec7e.png"></p>
<p><code>Image</code>をクリックして、コードを編集します。</p>
<p><img alt="s222" src="img/8173fbdee2b48f37.png"></p>
<p>プロパティ値は以下の通りです。</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>source</p>
</td><td colspan="1" rowspan="1"><p>https://github.com/gaomar/apl_handson/raw/master/files/background.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>height</p>
</td><td colspan="1" rowspan="1"><p>100vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>position</p>
</td><td colspan="1" rowspan="1"><p>absolute</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>scale</p>
</td><td colspan="1" rowspan="1"><p>best-fill</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>width</p>
</td><td colspan="1" rowspan="1"><p>100vw</p>
</td></tr>
</table>
<p>このままだと最初に表示した文字列が背景より後ろになってしまうので、表示順番を入れ替えます。<br><br>三部分をドラッグしてImageを上にもっていきます。</p>
<p><img alt="s223" src="img/809c0c6c48395ed1.png"></p>
<p>これで文字が見えるようになりました。</p>
<p><img alt="s224" src="img/1db804357466e10a.png"></p>
<h2>2-5. 背景色にオーバーレイカラーを載せる</h2>
<p>このままだと文字が見えにくいので背景色にオーバーレイカラーを載せて、文字を見やすくしてみましょう。</p>
<p>コードを下記のように修正してみましょう。<code>overlayColor</code>というプロパティを追加します。</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>overlayColor</p>
</td><td colspan="1" rowspan="1"><p>rgba(0, 0, 0, 0.6)</p>
</td></tr>
</table>
<p>これで文字が見やすくなりました。わざわざオーバーレイカラーの画像を作成しなくてもこのプロパティを追記するだけで簡単に作れます。</p>
<p><img alt="s225" src="img/4d20257bf4e979e0.png"></p>
<h2>2-6. デバイスの判定プロファイルを適用する</h2>
<p>Echo Spotはこのレイアウト、Echo Showではこのレイアウトという風に、デバイスに応じてレイアウトを変更することがあるかと思います。</p>
<p>デバイスの判定は<code>alexa-viewport-profiles</code>というものをインポートすると判定することができます。</p>
<p><img alt="s230" src="img/48e2849f089fa81f.png"></p>
<p>コード</p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [
        {
            &#34;name&#34;: &#34;alexa-viewport-profiles&#34;,
            &#34;version&#34;: &#34;1.0.0&#34;
        }
    ]
}
</code></pre>
<h2>2-7. 小型デバイスレイアウトを追加する</h2>
<p>小型デバイスのEcho Spot用のレイアウトを作ってみましょう。丸い形を活かしたデザインにします。<br><br>既にある<code>Image</code>を削除します。</p>
<p><img alt="s240" src="img/1e937b1855751ad5.png"></p>
<p>出てきたポップアップで<code>Proceed</code>をクリックします。</p>
<p><img alt="s241" src="img/1d3bd1b8e1ea340d.png"></p>
<p>次に2つ目の<code>Container</code>を選択して、ゴミ箱をクリックして削除します。</p>
<p><img alt="s242" src="img/f8d296feb6b589cd.png"></p>
<p><code>Container</code>を選択して［+］ボタンをクリックします。</p>
<p><img alt="s242-1" src="img/504f689779da0936.png"></p>
<p>出てきたポップアップで<code>Container</code>を選択して、［追加］ボタンをクリックします。</p>
<p><img alt="s243" src="img/38c87356ad7eb036.png"></p>
<p>もう１つ<code>Container</code>を追加します。</p>
<p><img alt="s244" src="img/add16a76de8a17fa.png"></p>
<p>このように2つできればOKです。</p>
<p><img alt="s245" src="img/89a3cc26f81a5aef.png"></p>
<h2>2-8. 小型デバイスレイアウトを適用する</h2>
<p>追加した1つ目の<code>Container</code>を選択して、whenプロパティに値を設定します。</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>when</p>
</td><td colspan="1" rowspan="1"><p>${@viewportProfile == @hubRoundSmall}</p>
</td></tr>
</table>
<p><img alt="s246" src="img/ef654e6fd114631d.png"></p>
<p>レイアウト判定は<code>when</code>プロパティを使います。whenはif文みたいなものです。<br><br>判定のプロパティ値は下記の通りです。</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>hubRoundSmall</p>
</td><td colspan="1" rowspan="1"><p>小型デバイス（Echo Spot）</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>hubLandscapeMedium</p>
</td><td colspan="1" rowspan="1"><p>中型デバイス（Echo Show 第１世代）</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>hubLandscapeLarge</p>
</td><td colspan="1" rowspan="1"><p>大型デバイス（Echo Show 第２世代）</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>tvLandscapeXLarge</p>
</td><td colspan="1" rowspan="1"><p>超大型TV（Fire TVなど）</p>
</td></tr>
</table>
<p>2つ目の<code>Container</code>をクリックして<code>Image</code>を追加します。</p>
<p><img alt="s247" src="img/9e89df0e2b046b24.png"></p>
<p><code>Image</code>を選択して、プロパティ値を入れます</p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>source</p>
</td><td colspan="1" rowspan="1"><p>https://github.com/gaomar/apl_handson/raw/master/files/ball.png</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>height</p>
</td><td colspan="1" rowspan="1"><p>100vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>position</p>
</td><td colspan="1" rowspan="1"><p>absolute</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>scale</p>
</td><td colspan="1" rowspan="1"><p>best-fill</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>weight</p>
</td><td colspan="1" rowspan="1"><p>100vw</p>
</td></tr>
</table>
<p>2つ目の<code>Container</code>をクリックして更に<code>Container</code>を追加します。</p>
<p>できた<code>Container</code>を選択してプロパティ値を設定します。</p>
<p><img alt="s248" src="img/8734c5c307c0621c.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>height</p>
</td><td colspan="1" rowspan="1"><p>100vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>justifyContent</p>
</td><td colspan="1" rowspan="1"><p>center</p>
</td></tr>
</table>
<p>追加した<code>Container</code>を選択して、更に<code>Text</code>を追加します。</p>
<p><img alt="s249" src="img/672a1b61f80a2838.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>text</p>
</td><td colspan="1" rowspan="1"><p>★</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>fontSize</p>
</td><td colspan="1" rowspan="1"><p>20vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>textAlign</p>
</td><td colspan="1" rowspan="1"><p>center</p>
</td></tr>
</table>
<h2>2-9. それ以外のレイアウトを適用する</h2>
<p>追加した一番下にある<code>Container</code>をクリックして、<code>Image</code>を追加します。</p>
<p><code>Image</code>を選択して、プロパティ値を設定します。</p>
<p><img alt="s250" src="img/b9c012ecc270a977.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>source</p>
</td><td colspan="1" rowspan="1"><p>https://github.com/gaomar/apl_handson/raw/master/files/background.jpg</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>height</p>
</td><td colspan="1" rowspan="1"><p>100vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>overlayColor</p>
</td><td colspan="1" rowspan="1"><p>rgba(0, 0, 0, 0.6)</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>position</p>
</td><td colspan="1" rowspan="1"><p>absolute</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>scale</p>
</td><td colspan="1" rowspan="1"><p>best-fill</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>width</p>
</td><td colspan="1" rowspan="1"><p>100vw</p>
</td></tr>
</table>
<p>一番下にある<code>Container</code>を選択して、更に<code>Container</code>を追加します。</p>
<p>追加した<code>Container</code>を選択して、プロパティ値を設定します。</p>
<p><img alt="s251" src="img/8d08fbec7c7125b9.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>height</p>
</td><td colspan="1" rowspan="1"><p>100vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>justifyContent</p>
</td><td colspan="1" rowspan="1"><p>center</p>
</td></tr>
</table>
<p>一番下にある<code>Container</code>を選択して<code>Text</code>を追加します。</p>
<p>追加した<code>Text</code>を選択してプロパティ値を設定します。</p>
<p><img alt="s252" src="img/6e4503f4f260d0b6.png"></p>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>text</p>
</td><td colspan="1" rowspan="1"><p>${payload.hello.text}</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>fontSize</p>
</td><td colspan="1" rowspan="1"><p>5vh</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>textAlign</p>
</td><td colspan="1" rowspan="1"><p>center</p>
</td></tr>
</table>
<p>最終的にこのようなレイアウトになれば完成です。</p>
<p><img alt="s253" src="img/8b20b0dfb122f131.png"></p>
<p>うまくいかない方はこちらからダウンロードしてファイルをインポートしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_layout.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_layout.json</a></p>
<h2>2-10. レイアウトを確認する</h2>
<p>小型デバイスや中型デバイスに切り替えると適用したレイアウトに切り替わると思います。</p>
<p><img alt="s260" src="img/3f93d8f78baef063.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="APLをスキルから適用する" duration="0">
        <p>これまで作ってきたAPLをスキルから呼び出してみましょう。<br><br>まずはコードを一旦書き出してみます。右上にある［コード書き出し］ボタンをクリックしてダウンロードできます。</p>
<p><img alt="s300" src="img/752dd8ad2f1a6d83.png"></p>
<p><code>apl_template_export.json</code>ファイルがダウンロードされますので開いてください。<br><br>document部分のみを選択してください。</p>
<p><img alt="s300-1" src="img/564ee6f6419cc8c0.png"></p>
<h2>3-1. documentを新規作成する</h2>
<p>document部分のみをコピーしてデベロッパーコンソールの［コードエディタ］タブをクリックしてから左上の新規ドキュメントアイコンをクリックして作成します。</p>
<p><img alt="s301" src="img/b2dbcd7766815e5b.png"></p>
<p>ファイル名を<code>apl_document.json</code>として［Create File］ボタンをクリックします。</p>
<p><img alt="s302" src="img/e3042af02c81b42b.png"></p>
<p>先程コピーしたコードを貼り付けます。貼り付けたら［Save］ボタン押します。</p>
<p><img alt="s303" src="img/ac8edf90fc9f883e.png"></p>
<p>コードはこちら。<br><a href="https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_document.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_document.json</a></p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [
        {
            &#34;name&#34;: &#34;alexa-viewport-profiles&#34;,
            &#34;version&#34;: &#34;1.0.0&#34;
        }
    ],
    &#34;resources&#34;: [
        {
            &#34;strings&#34;: {
                &#34;skillName&#34;: &#34;HelloAPL&#34;
            }
        }
    ],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {},
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [
            &#34;payload&#34;
        ],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;items&#34;: [
                    {
                        &#34;when&#34;: &#34;${@viewportProfile == @hubRoundSmall}&#34;,
                        &#34;type&#34;: &#34;Container&#34;,
                        &#34;items&#34;: [
                            {
                                &#34;type&#34;: &#34;Image&#34;,
                                &#34;source&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/ball.png&#34;,
                                &#34;scale&#34;: &#34;best-fill&#34;,
                                &#34;width&#34;: &#34;100vw&#34;,
                                &#34;height&#34;: &#34;100vh&#34;,
                                &#34;position&#34;: &#34;absolute&#34;
                            },
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;justifyContent&#34;: &#34;center&#34;,
                                &#34;height&#34;: &#34;100vh&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;Text&#34;,
                                        &#34;text&#34;: &#34;★&#34;,
                                        &#34;textAlign&#34;: &#34;center&#34;,
                                        &#34;fontSize&#34;: &#34;20vh&#34;
                                    }
                                ]
                            }
                        ]
                    },
                    {
                        &#34;type&#34;: &#34;Container&#34;,
                        &#34;items&#34;: [
                            {
                                &#34;type&#34;: &#34;Image&#34;,
                                &#34;source&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/background.jpg&#34;,
                                &#34;scale&#34;: &#34;best-fill&#34;,
                                &#34;width&#34;: &#34;100vw&#34;,
                                &#34;height&#34;: &#34;100vh&#34;,
                                &#34;position&#34;: &#34;absolute&#34;,
                                &#34;overlayColor&#34;: &#34;rgba(0, 0, 0, 0.6)&#34;
                            },
                            {
                                &#34;type&#34;: &#34;Container&#34;,
                                &#34;justifyContent&#34;: &#34;center&#34;,
                                &#34;height&#34;: &#34;100vh&#34;,
                                &#34;item&#34;: [
                                    {
                                        &#34;type&#34;: &#34;Text&#34;,
                                        &#34;text&#34;: &#34;${payload.hello.text}&#34;,
                                        &#34;textAlign&#34;: &#34;center&#34;,
                                        &#34;fontSize&#34;: &#34;5vh&#34;
                                    }
                                ]
                            }
                        ]
                    }
                ]
            }
        ]
    }
}
</code></pre>
<h2>3-2. スキルプログラムを編集する</h2>
<p>既にあるindex.jsファイルを開きます。6行目にある<code>LaunchRequestHandler</code>の関数を編集します。<br>addDirectiveという部分でAPLのdocumentを指定します。<br><br>datasourcesに中型デバイスで表示する文字列を指定します。</p>
<p>コードを編集したら、［Save］と［Deploy］をクリックしてください。</p>
<p><img alt="s304" src="img/75200d3d58cdd7a6.png"></p>
<pre><code>const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ハローAPL&#39;;
        // documentとdataをそれぞれ指定する
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_document.json&#39;),
                datasources: {
                    &#34;hello&#34;: {
                        &#34;text&#34;: &#34;ハローAPL&#34;
                    }
                }
            })            
            .getResponse();
    }
};
</code></pre>
<p>［テスト］タブをクリックしてシミュレーター画面を表示してください。シミュレーターで実行するとAPLが適用されたレイアウトを確認することができます。</p>
<p><img alt="s305" src="img/f699e61ac33199e7.png"></p>
<p>実機で確認もしてみてください。<br>Echo Spotだとますますドラゴ◯ボールっぽく見えますね</p>
<p><img alt="s306" src="img/e08bde5ffaa4bf83.png"></p>
<h2>3-3. Alexa-hostedのS3から画像を呼ぶ</h2>
<p>Alexa-hostedにはS3も使えます。<br>コードエディタの左下にS3のリンクがあるのでクリックします。</p>
<p><img alt="s310" src="img/7570e2930cb6cdbd.png"></p>
<p>S3のページが表示されたら、画像をアップロードするので［アップロード］ボタンを押します。</p>
<p><img alt="s311" src="img/a1619474beabfa18.png"></p>
<p>お好きな画像でも良いですし、こちらのball.pngファイルでも構いません。<br>好きなファイルをアップロードしましょう。</p>
<p><img alt="s312" src="img/6dc049a2f015149f.png"></p>
<p>apl_document.jsonを開いて、34行目のsourceの値を変更します。<br><code>${payload.hello.ballImage}</code>に変えてください。</p>
<p><img alt="s313" src="img/e548ef51720cb88.png"></p>
<p>index.jsも編集します。S3に保存している画像ファイルのURLを取得しましょう。</p>
<p><img alt="s314" src="img/c5c356b10b485944.png"></p>
<p>下記のように編集します。</p>
<pre><code>const Alexa = require(&#39;ask-sdk-core&#39;);
const Util = require(&#39;util.js&#39;);

const LaunchRequestHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;LaunchRequest&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;ハローAPL&#39;;
        const pictureUrl = Util.getS3PreSignedUrl(&#34;Media/ball.png&#34;);

        // documentとdataをそれぞれ指定する
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_document.json&#39;),
                datasources: {
                    &#34;hello&#34;: {
                        &#34;text&#34;: &#34;ハローAPL&#34;,
                        &#34;ballImage&#34;: pictureUrl
                    }
                }
            })            
            .getResponse();
    }
};
</code></pre>
<p>今まではGithub経由で呼び出していた画像が、これでAlexa-hostedのS3側にあるファイルから呼び出すことができました。</p>


      </google-codelab-step>
    
      <google-codelab-step label="タッチ処理を実装しよう" duration="0">
        <p>画面タッチ処理を実装します。タッチしたらイベントを検知して数をカウントする<br><br>昔流行った「へぇボタン」を作ります。</p>
<p><img alt="s400" src="img/3aa333b54bf6e21a.png"></p>
<h2>4-1. インテントを追加する</h2>
<p>へぇボタンの画面を表示させるために、インテントを新規作成します。<br><br>［ビルド］タブをクリックして、インテントの［追加］ボタンをクリックして、インテント名を<code>HeeIntent</code>と入力します。［カスタムインテントを作成］ボタンをクリックして作成します。</p>
<p><img alt="s401" src="img/f434a7629d6de022.png"></p>
<p>このインテントが反応するための言葉を登録します。サンプル発話に「へぇボタン」と入力して、<code>Enter</code>キーを押してください。</p>
<p>最後に必ずインテントの［モデルを保存］ボタンと［モデルをビルド］ボタンをそれぞれクリックします。</p>
<p><img alt="s402" src="img/fd04ad348cd02008.png"></p>
<h2>4-2. APLを実装する</h2>
<p>APLのレイアウトを組み込みます。［コードエディタ］タブをクリックしてから、左上の新規ドキュメントアイコンをクリックして作成してください。<br><br>ファイル名は「apl_hee.json」としました。</p>
<p><img alt="s403" src="img/269beebcd42df1ca.png"></p>
<p>コードは下記の通りです。</p>
<pre><code>{
    &#34;type&#34;: &#34;APL&#34;,
    &#34;version&#34;: &#34;1.0&#34;,
    &#34;theme&#34;: &#34;dark&#34;,
    &#34;import&#34;: [],
    &#34;resources&#34;: [],
    &#34;styles&#34;: {},
    &#34;layouts&#34;: {
        &#34;heeLayout&#34;: {
            &#34;parameters&#34;: [
                {
                    &#34;name&#34;: &#34;imageUrl&#34;,
                    &#34;type&#34;: &#34;string&#34;
                }
            ],
            &#34;items&#34;: [
                {
                    &#34;type&#34;: &#34;Container&#34;,
                    &#34;alignItems&#34;: &#34;center&#34;,
                    &#34;justifyContent&#34;: &#34;center&#34;,
                    &#34;height&#34;: &#34;100vh&#34;,
                    &#34;items&#34;: [
                        {
                            &#34;type&#34;: &#34;Image&#34;,
                            &#34;scale&#34;: &#34;best-fit&#34;,
                            &#34;height&#34;: &#34;50vh&#34;,
                            &#34;width&#34;: &#34;50vw&#34;,
                            &#34;align&#34;: &#34;center&#34;,
                            &#34;source&#34;: &#34;${imageUrl}&#34;
                        }
                    ]
                }
            ]
        }
    },
    &#34;mainTemplate&#34;: {
        &#34;parameters&#34;: [&#34;payload&#34;],
        &#34;items&#34;: [
            {
                &#34;type&#34;: &#34;Container&#34;,
                &#34;items&#34;: [
                    {
                        &#34;type&#34;: &#34;Pager&#34;,
                        &#34;width&#34;: &#34;100vw&#34;,
                        &#34;height&#34;: &#34;100vh&#34;,
                        &#34;id&#34;: &#34;myPager&#34;,
                        &#34;initialPage&#34;: 0,
                        &#34;items&#34;: [
                            {
                                &#34;type&#34;: &#34;TouchWrapper&#34;,
                                &#34;onPress&#34;: {
                                    &#34;type&#34;: &#34;SendEvent&#34;,
                                    &#34;arguments&#34;: [
                                        &#34;touch&#34;
                                    ]
                                },
                                &#34;item&#34;: {
                                    &#34;type&#34;: &#34;heeLayout&#34;,
                                    &#34;imageUrl&#34;: &#34;${payload.hello.hee_off}&#34;
                                }
                            },
                            {
                                &#34;type&#34;: &#34;heeLayout&#34;,
                                &#34;imageUrl&#34;: &#34;${payload.hello.hee_on}&#34;
                            }
                        ]
                    },
                    {
                        &#34;type&#34;: &#34;Container&#34;,
                        &#34;height&#34;: &#34;100vh&#34;,
                        &#34;position&#34;:&#34;absolute&#34;,
                        &#34;alignItems&#34;: &#34;center&#34;,
                        &#34;justifyContent&#34;: &#34;end&#34;,
                        &#34;paddingBottom&#34;: &#34;10vh&#34;,
                        &#34;items&#34;: {
                            &#34;type&#34;: &#34;Text&#34;,
                            &#34;width&#34;: &#34;100vw&#34;,
                            &#34;textAlign&#34;: &#34;center&#34;,
                            &#34;text&#34;: &#34;${payload.hello.myCount}&#34;
                        }                        
                    }
                ]
            }
        ]
    }
}
</code></pre>
<p><a href="https://developer.amazon.com/alexa/console/ask/displays" target="_blank">APLオーサリングツール</a>でこのコードを貼り付けると以下のようになります。<br><code>heeLayout</code>とありますが、自分でオリジナルのレイアウトを適用することができます。</p>
<p>※実際にAPLオーサリングツールで試す場合はこちらのjsonファイルで試してください<br><a href="https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_hee.json" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson/master/files/apl_hee.json</a></p>
<p><img alt="s404" src="img/7ee47ef9928d4678.png"></p>
<p>typeの<code>Pager</code>で画面をスワイプするとへぇボタンのOFFとON画像が切り替わります。またOFF状態のへぇボタンをタッチできるように<code>TouchWrapper</code>を使います。</p>
<h2>4-3. プログラムを修正する</h2>
<p>APLを適用するためにindex.jsファイルを編集します。コードエディタからindex.jsを開いてください。</p>
<p>コード量が多いので抜粋しています。全コードはこちらからダウンロードしてください。</p>
<p><a href="https://raw.githubusercontent.com/gaomar/apl_handson/master/files/index.js" target="_blank">https://raw.githubusercontent.com/gaomar/apl_handson/master/files/index.js</a></p>
<p>※自分で編集される際は<code>addRequestHandlers</code>に関数を追加するのを忘れないようにしてください。</p>
<pre><code>const HeeIntentHandler = {
    canHandle(handlerInput) {
        return handlerInput.requestEnvelope.request.type === &#39;IntentRequest&#39;
            &amp;&amp; handlerInput.requestEnvelope.request.intent.name === &#39;HeeIntent&#39;;
    },
    handle(handlerInput) {
        const speechText = &#39;へぇ〜&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_hee.json&#39;),
                datasources: {
                    &#34;hello&#34;: {
                        &#34;hee_off&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/hee_off.png&#34;,
                        &#34;hee_on&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/hee_on.png&#34;,
                        &#34;myCount&#34;: 0
                    }
                }
            })            
            .getResponse();
    }
};
const TouchEventHandler = {
    canHandle(handlerInput) {
    return ((handlerInput.requestEnvelope.request.type === &#39;Alexa.Presentation.APL.UserEvent&#39; &amp;&amp;
        (handlerInput.requestEnvelope.request.source.handler === &#39;Press&#39; || 
        handlerInput.requestEnvelope.request.source.handler === &#39;onPress&#39;)));
    },
    handle(handlerInput) {
        // セッション情報の取得
        var myCount = 0;
        const attributes = handlerInput.attributesManager.getSessionAttributes();
        // 初期化
        if(!attributes.counter){ 
            myCount = 1;
        } else {
            myCount = attributes.counter;
            myCount++;
        }
        attributes.counter = myCount;
        handlerInput.attributesManager.setSessionAttributes(attributes);

        const speechText = &#39;へぇ〜&#39;;
        return handlerInput.responseBuilder
            .speak(speechText)
            .addDirective({
                type : &#39;Alexa.Presentation.APL.ExecuteCommands&#39;,
                token: &#34;token&#34;,
                commands: [
                    {
                        type: &#34;Sequential&#34;,
                        commands: [
                            {
                                &#34;type&#34;: &#34;SetPage&#34;,
                                &#34;componentId&#34;: &#34;myPager&#34;,
                                &#34;position&#34;: &#34;absolute&#34;,
                                &#34;value&#34;: 1
                            },
                            {
                                type: &#34;Idle&#34;,
                                delay: 500
                            },
                            {
                                &#34;type&#34;: &#34;SetPage&#34;,
                                &#34;componentId&#34;: &#34;myPager&#34;,
                                &#34;position&#34;: &#34;absolute&#34;,
                                &#34;value&#34;: 0
                            }
                        ]
                    }
                ]
            }) 
            .addDirective({
                type : &#39;Alexa.Presentation.APL.RenderDocument&#39;,
                version: &#39;1.0&#39;,
                token: &#34;token&#34;,
                document: require(&#39;./apl_hee.json&#39;),
                datasources: {
                    &#34;hello&#34;: {
                        &#34;hee_off&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/hee_off.png&#34;,
                        &#34;hee_on&#34;: &#34;https://github.com/gaomar/apl_handson/raw/master/files/hee_on.png&#34;,
                        &#34;myCount&#34;: myCount
                    }
                }
            })
            .getResponse();            
    }
};
</code></pre>
<h2>コード解説</h2>
<p>画面タッチ処理はAPL側の<code>TouchWrapper</code>でトリガーされます。<br><br>タッチされたら、index.js側の<code>Alexa.Presentation.APL.UserEvent</code>が飛んでくるので、<code>Press</code>か<code>onPress</code>のどちらかで受け取ります。</p>
<p><code>Alexa.Presentation.APL.ExecuteCommands</code>でAPLに対してコマンドを送っています。今回送っているコマンドは、シーケンス処理で、順番に処理を行っていくコマンドです。</p>
<p><code>SetPage</code>のvalueで次のページを自動的に表示させています。<code>Idle</code>で500ミリ秒待ってから再度<code>SetPage</code>で一番最初のページを表示させています。</p>
<p>最後にカウントを加算するためにAPLを再度読み込み直しています。</p>
<h2>完成</h2>
<p><img alt="s405" src="img/b8157f8248b0eb65.png"></p>
<p>早く終わった方は20へぇ到達で違う画像に切替えたり、0へぇに戻すというような処理を付け加えてみてはいかがでしょうか？</p>
<h2>まとめ</h2>
<p>今回のハンズオンではたくさんあるAPL機能の一部です！<br><br>他にもたくさんの機能やテクニックがあるので、これを機にチャレンジしてみてください！</p>


      </google-codelab-step>
    
  </google-codelab>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-49880327-14', 'auto');

    (function() {
      var gaCodelab = '';
      if (gaCodelab) {
        ga('create', gaCodelab, 'auto', {name: 'codelab'});
      }

      var gaView;
      var parts = location.search.substring(1).split('&');
      for (var i = 0; i < parts.length; i++) {
        var param = parts[i].split('=');
        if (param[0] === 'viewga') {
          gaView = param[1];
          break;
        }
      }
      if (gaView && gaView !== gaCodelab) {
        ga('create', gaView, 'auto', {name: 'view'});
      }
    })();
  </script>

</body>
</html>
